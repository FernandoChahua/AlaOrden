<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html 	xmlns="http://www.w3.org/1999/xhtml"
       xmlns:h="http://java.sun.com/jsf/html"
       xmlns:f="http://java.sun.com/jsf/core"
       xmlns:ui="http://java.sun.com/jsf/facelets">

    <h:head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
        <style>
            #map {
                width:100%;
                height: 400px;
            }
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #direccion,#longitude,#latitude {
                visibility: hidden;
                display: none;
            }
        </style>
    </h:head>

    <h:body>
        <div id="container">
            <div class="row">
                <div class="col-md-10">
                    <input id="autocomplete" class="form-control" type="text" />
                    <input id="direccion" class="form-control"  value="#{direccionController.direccion}" type="text"/>
                    <div id="map"></div>
                </div>
            </div>
        </div>
        <h:inputText id="latitude" 
                     value="#{direccionController.latitud}" required="true" />
        <h:inputText id="longitude"
                     value="#{direccionController.longitud}" required="true" />
        <h:button>
        </h:button>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDT3BrfPIJPb8V-JdIlHkUcCaPxza33unY&amp;libraries=places"></script>
        <script>
            var marker;
            var map;
            var geocoder;
            var infowindow;
            google.maps.event.addDomListener(window, "load", function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {

                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        geocoder = new google.maps.Geocoder;
                        infowindow = new google.maps.InfoWindow;
                        map = new google.maps.Map(document.getElementById('map'), {
                            center: {lat: pos.lat, lng: pos.lng},
                            zoom: 20
                        });
                        marker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            draggable: false,
                            animation: google.maps.Animation.DROP
                        });
                        document.getElementById("latitude").value = pos.lat;
                        document.getElementById("longitude").value = pos.lng;
                        geocodeLatLng(pos);
                        function addMarker(location, map) {
                            marker.setMap(null);
                            marker = new google.maps.Marker({
                                position: location,
                                map: map,
                                draggable: true,
                                animation: google.maps.Animation.DROP
                            });
                            document.getElementById("latitude").value = location.lat;
                            document.getElementById("longitude").value = location.lng;
                            map.setCenter(location);
                            map.setZoom(18);


                        }
                        var autocomplete = document.getElementById('autocomplete');
                        const search = new google.maps.places.Autocomplete(autocomplete);
                        search.bindTo("bounds", map);

                        search.addListener('place_changed', function () {
                            var place = search.getPlace();
                            if (!place.geometry.viewport) {
                                window.alert("Error al mostrar el lugar");
                                return;
                            }
                            if (place.geometry.viewport) {
                                map.fitBounds(place.geometry.viewport);
                                geocodeLatLng(place.geometry.location, map);
                            } else {
                                geocodeLatLng(place.geometry.location, map);
                            }

                        });
                        function geocodeLatLng(longitud) {
                            var latlng = longitud;
                            geocoder.geocode({'location': latlng}, function (results, status) {
                                if (status === 'OK') {
                                    if (results[0]) {
                                        addMarker(longitud, map);
                                        infowindow.setContent(results[0].formatted_address);
                                        infowindow.open(map, marker);
                                        document.getElementById("direccion").value = results[0].formatted_address;
                                        document.getElementById("autocomplete").value = results[0].formatted_address;
                                    } else {
                                        window.alert('No results found');
                                    }
                                } else {
                                    window.alert('Geocoder failed due to: ' + status);
                                }
                            });
                        }
                        google.maps.event.addListener(map, 'click', function (event) {
                            geocodeLatLng(event.latLng);
                        });
                    }, function () {
                        handleLocationError(true, infoWindow, map.getCenter());
                    });
                } else {
                    handleLocationError(false, infoWindow, map.getCenter());
                }



            });



            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
            }
        </script>
    </h:body>
</html>